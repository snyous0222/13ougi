/* ===== å®šæ•°ãƒ»ãƒ‡ãƒ¼ã‚¿å®šç¾© ===== */
const INIT_HP = 70, MAX_HP = 100, MAX_OP = 30;
const OUGI_DEFS = [
    { id: 1, name: 'ã‚¸ãƒ£ãƒƒã‚«ãƒ«', cost: 4, ct: 1, attr: 'choki', prio: 0, icon: 'ğŸº', desc: 'ã‚°ãƒ¼ã«è² ã‘ã€‚ãƒãƒ§ã‚­3ç‚¹ã€ãƒ‘ãƒ¼/ç‰¹æ®Š5ç‚¹ãƒ€ãƒ¡' },
    { id: 2, name: 'ç†±æ„›ç™ºè¦š', cost: 5, ct: 2, attr: 'goo', prio: 0, icon: 'ğŸ’˜', desc: 'ç›¸æ‰‹ã®å‡ºã—ãŸå±æ€§ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«3Tå°å°ã€‚è² ã‘ã®å ´åˆã¯è‡ªåˆ†ã®ã‚°ãƒ¼å°å°' },
    { id: 3, name: 'ãƒãƒã®å‘³', cost: 8, ct: 2, attr: 'goo', prio: 0, icon: 'ğŸ±', desc: 'è‡ªåˆ†HP+10ã€‚ç›¸æ‰‹ãƒ‘ãƒ¼æ™‚ä¸¡è€…+10' },
    { id: 4, name: 'ç´„æŸã®æ—¥', cost: 4, ct: 6, attr: 'choki', prio: 0, icon: 'ğŸ“…', desc: 'ã‚°ãƒ¼ã«è² ã‘ã€‚ãã‚Œä»¥å¤–ã§æ¬¡ã®è¢«ãƒ€ãƒ¡ç„¡åŠ¹' },
    { id: 5, name: 'è²·å', cost: 5, ct: 10, attr: 'pa', prio: 0, icon: 'ğŸ’´', desc: 'è‡ªHP-15ã€OP+15ï¼ˆãƒãƒ§ã‚­ç›¸æ‰‹æ™‚ç„¡åŠ¹ï¼‰' },
    { id: 6, name: 'è¦ªå‹', cost: 6, ct: 3, attr: 'pa', prio: 0, icon: 'ğŸ¤', desc: 'ãƒ€ãƒ¡ãƒ¼ã‚¸å…±æœ‰ã€‚ãƒãƒ§ã‚­ã«è² ã‘' },
    { id: 7, name: 'ç§‘å­¦åŠ›', cost: 4, ct: 0, attr: 'special', prio: 0, icon: 'ğŸ”¬', desc: 'ON/OFFãƒˆã‚°ãƒ«ï¼ˆç™ºå‹•OP4ï¼‰ã€‚æ¯ã‚¿ãƒ¼OP-5ï¼ˆä¸è¶³åˆ†HPä»£æ›¿ï¼‰ã€ç›¸æ‰‹+3ãƒ€ãƒ¡' },
    { id: 8, name: 'è¶…é«˜é€Ÿç ´å£Šæ‹³', cost: 15, ct: 10, attr: 'choki', prio: 0, icon: 'ğŸ‘Š', desc: 'ãƒ‘ãƒ¼ã«30ãƒ€ãƒ¡ã€‚ãã‚Œä»¥å¤–ã¯è‡ªæ»…+CT+2' },
    { id: 9, name: 'é«­ãƒ€ãƒ³ãƒ‡ã‚£', cost: 4, ct: 5, attr: 'special', prio: 3, icon: 'ğŸ¥¸', desc: 'å„ªå…ˆ+3ã€‚ç›¸æ‰‹ã®æ‰‹ã‚’å¼·åˆ¶çš„ã«é«­ãƒ€ãƒ³ãƒ‡ã‚£ã«å¤‰æ›´ï¼ˆç›¸æ‰‹ã‚‚OPæ¶ˆè²»ã€ä¸è¶³æ™‚OP=0ï¼‰' },
    { id: 10, name: 'é»„æ˜', cost: 0, ct: 7, attr: 'special', prio: 2, icon: 'ğŸŒ…', desc: 'å„ªå…ˆ+2ã€‚ç›¸æ‰‹å¥¥ç¾©ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚HP+5 OP+5ã€‚HP30ä»¥ä¸‹é™å®šã€‚é€šå¸¸æ‰‹ç›¸æ‰‹æ™‚è‡ªå‚·5' },
    { id: 11, name: 'ãƒãƒƒã‚­ãƒ³ã‚°', cost: 15, ct: 2, attr: 'special', prio: 0, icon: 'ğŸ’»', desc: 'ç›¸æ‰‹æ‰‹ç¢ºèªå¾Œã«é¸æŠã€‚ç›¸æ‰‹ãŒç´„æŸã®æ—¥ã§OP+15' },
    { id: 12, name: 'ã‚¨ãƒ³ã‚¸ã‚§ãƒ«éšŠ', cost: 0, ct: 99, attr: 'special', prio: 9, icon: 'ğŸ‘¼', desc: 'å…¨çŠ¶æ…‹åˆæœŸåŒ–ã€‚ä¸¡è€…HP1 OP0 CT99ã€‚æ¡ä»¶ä»˜ãç™ºå‹•' },
    { id: 13, name: 'ã‚¸ãƒ£ãƒ³ã‚±ãƒ³çŸ¥ã‚Šã¾ã›ã‚“', cost: 20, ct: 99, attr: 'special', prio: 5, icon: 'ğŸƒ', desc: '1ã€œ50ãƒ©ãƒ³ãƒ€ãƒ ãƒ€ãƒ¡ã€‚é˜²å¾¡ç„¡åŠ¹' },
];

const ATTR_LABEL = { goo: 'ã‚°ãƒ¼å±æ€§', choki: 'ãƒãƒ§ã‚­å±æ€§', pa: 'ãƒ‘ãƒ¼å±æ€§', special: 'ç‰¹æ®Šå±æ€§' };
const ATTR_CLASS = { goo: 'attr-goo', choki: 'attr-choki', pa: 'attr-pa', special: 'attr-special' };
const MOVE_ICONS = { goo: 'âœŠ', choki: 'âœŒï¸', pa: 'ğŸ–ï¸' };
const MOVE_NAMES = { goo: 'ã‚°ãƒ¼', choki: 'ãƒãƒ§ã‚­', pa: 'ãƒ‘ãƒ¼' };

// ä¸‰ã™ãã¿: A vs B â†’ Aå‹ã¡
const BEATS = { goo: 'choki', choki: 'pa', pa: 'goo' };

/* ===== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ===== */
function makeState() {
    return {
        hp: INIT_HP, maxHp: MAX_HP, op: 0, maxOp: MAX_OP,
        seals: { goo: 0, choki: 0, pa: 0, special: 0 }, // æ®‹ã‚¿ãƒ¼ãƒ³æ•°
        cts: {}, // ougiId â†’ æ®‹CT
        scienceOn: false,
        shieldNext: false,    // ç´„æŸã®æ—¥ãƒ»è¢«ãƒ€ãƒ¡ç„¡åŠ¹
        sharedDmg: false,     // è¦ªå‹ãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å…±æœ‰
        usedOugiIds: new Set(), // ã‚¨ãƒ³ã‚¸ã‚§ãƒ«éšŠæ¡ä»¶ç”¨
        angelCondition: false,  // ã‚¨ãƒ³ã‚¸ã‚§ãƒ«éšŠãŒä½¿ç”¨å¯èƒ½ã‹
    };
}

let G; // gameState: { player, enemy, turn, phase, selecting, hackingPending }

/* ===== åˆæœŸåŒ– ===== */
function initGame() {
    G = {
        player: makeState(),
        enemy: makeState(),
        turn: 1,
        phase: 'select', // 'select' | 'result' | 'over'
        playerChoice: null,
        enemyChoice: null,
        hackingPending: null, // ãƒãƒƒã‚­ãƒ³ã‚°ç™ºå‹•æ™‚ã®ä¿ç•™çŠ¶æ…‹
    };
    clearLog();
    addLog('ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹ï¼å¥¥ç¾©ã‚’é§†ä½¿ã—ã¦å‹åˆ©ã‚’æ´ã‚ï¼', 'system');
    renderUI();
    renderOugiGrid();
    enableSelect();
}

/* ===== UIæ›´æ–° ===== */
function renderUI() {
    updatePanel('p', G.player);
    updatePanel('e', G.enemy);
    document.getElementById('turn-display').textContent = `ã‚¿ãƒ¼ãƒ³ ${G.turn}`;
}

function updatePanel(prefix, st) {
    const hpPct = Math.max(0, (st.hp / st.maxHp) * 100);
    const opPct = (st.op / st.maxOp) * 100;
    document.getElementById(`${prefix}-hp-val`).textContent = `${Math.max(0, st.hp)}/${st.maxHp}`;
    document.getElementById(`${prefix}-op-val`).textContent = `${st.op}/${st.maxOp}`;
    const hpBar = document.getElementById(`${prefix}-hp-bar`);
    hpBar.style.width = hpPct + '%';
    hpBar.className = 'bar-fill hp-fill' + (st.hp <= 25 ? ' low' : '');
    document.getElementById(`${prefix}-op-bar`).style.width = opPct + '%';

    // ã‚¿ã‚°è¡¨ç¤º
    const tags = document.getElementById(`${prefix}-tags`);
    tags.innerHTML = '';
    for (const [attr, rem] of Object.entries(st.seals)) {
        if (rem > 0) tags.innerHTML += `<span class="tag tag-seal">${MOVE_NAMES[attr] || attr}å°å°${rem}T</span>`;
    }
    if (st.scienceOn) tags.innerHTML += `<span class="tag tag-science">ç§‘å­¦åŠ›ON</span>`;
    if (st.shieldNext) tags.innerHTML += `<span class="tag tag-shield">æ¬¡è¢«ãƒ€ãƒ¡ç„¡åŠ¹</span>`;
    if (st.sharedDmg) tags.innerHTML += `<span class="tag tag-buff">ãƒ€ãƒ¡å…±æœ‰</span>`;
    if (st.angelCondition) {
        tags.innerHTML += `<span class="tag tag-buff">ğŸ‘¼éšŠæ¡ä»¶é”æˆ</span>`;
    } else {
        const cond = [1, 2, 3, 4, 5, 9, 11];
        const done = cond.filter(id => st.usedOugiIds.has(id)).length;
        if (done > 0) tags.innerHTML += `<span class="tag tag-debuff">ğŸ‘¼${done}/7</span>`;
    }
}

function renderOugiGrid() {
    const grid = document.getElementById('ougi-grid');
    grid.innerHTML = '';
    for (const o of OUGI_DEFS) {
        const btn = document.createElement('button');
        btn.className = 'ougi-btn';
        btn.id = `ougi-btn-${o.id}`;
        const ct = G.player.cts[o.id] || 0;
        const sealed = isOugiSealed(G.player, o);
        const affordable = G.player.op >= o.cost;
        const angelCond = (o.id === 12) && !G.player.angelCondition;
        // é»„æ˜ï¼šHP30ä»¥ä¸‹ã§ãªã„ã¨ä½¿ç”¨ä¸å¯
        const tasogareBlock = (o.id === 10) && G.player.hp > 30;
        const disabled = ct > 0 || !affordable || angelCond || tasogareBlock;
        btn.disabled = disabled || sealed;
        if (sealed) btn.classList.add('sealed');
        if (o.id === 7 && G.player.scienceOn) btn.classList.add('active-toggle');

        // ã‚¨ãƒ³ã‚¸ã‚§ãƒ«éšŠï¼šé€²æ—ãƒãƒ¼ç”Ÿæˆ
        let extraHtml = '';
        if (o.id === 12) {
            const condIds = [1, 2, 3, 4, 5, 9, 11];
            const done = condIds.filter(id => G.player.usedOugiIds.has(id)).length;
            const pct = Math.floor((done / 7) * 100);
            const condIcons = condIds.map(id => {
                const def = OUGI_DEFS.find(x => x.id === id);
                const used = G.player.usedOugiIds.has(id);
                return `<span style="opacity:${used ? 1 : 0.25};font-size:0.7rem" title="${def?.name}">${def?.icon}</span>`;
            }).join('');
            extraHtml = `
              <div style="margin-top:4px">
                <div style="font-size:0.65rem;color:#9070b0;margin-bottom:2px">æ¡ä»¶ ${done}/7</div>
                <div style="background:rgba(0,0,0,0.4);border-radius:4px;height:5px;overflow:hidden;margin-bottom:3px">
                  <div style="background:linear-gradient(90deg,#a060ff,#ff60cc);width:${pct}%;height:100%;border-radius:4px;transition:width 0.3s"></div>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:1px">${condIcons}</div>
              </div>`;
        }
        // é»„æ˜ï¼šHPæ¡ä»¶è¡¨ç¤º
        if (o.id === 10 && tasogareBlock) {
            extraHtml += `<div style="font-size:0.65rem;color:#ff8050;margin-top:3px">HP30ä»¥ä¸‹ã§ç™ºå‹•å¯</div>`;
        }

        btn.innerHTML = `
      <span class="o-name">${o.icon} ${o.name}</span>
      <span class="o-cost">æ¶ˆè²»OP: ${o.cost}</span>
      <span class="o-attr ${ATTR_CLASS[o.attr]}">${ATTR_LABEL[o.attr]}</span>
      ${ct > 0 ? `<span class="ct-remaining">CT${ct}</span>` : `<span class="o-ct">CT${o.ct}</span>`}
      ${extraHtml}
    `;
        btn.setAttribute('data-tip', o.desc);
        if (!btn.disabled) btn.onclick = () => playerSelectOugi(o.id);
        grid.appendChild(btn);
    }
}

function isOugiSealed(st, o) {
    return (st.seals[o.attr] || 0) > 0;
}

function enableSelect() {
    document.getElementById('select-area').style.pointerEvents = 'auto';
    document.getElementById('select-area').style.opacity = '1';
    ['goo', 'choki', 'pa'].forEach(m => {
        const btn = document.getElementById(`btn-${m}`);
        btn.disabled = (G.player.seals[m] || 0) > 0;
        btn.className = 'move-btn' + (btn.disabled ? ' sealed' : '');
    });
    renderOugiGrid();
}

function disableSelect() {
    document.getElementById('select-area').style.pointerEvents = 'none';
    document.getElementById('select-area').style.opacity = '0.5';
}

/* ===== ãƒ­ã‚° ===== */
function addLog(msg, type = 'system') {
    const el = document.getElementById('log-container');
    const div = document.createElement('div');
    div.className = `log-line log-${type}`;
    div.textContent = msg;
    el.appendChild(div);
    el.scrollTop = el.scrollHeight;
}
function clearLog() {
    document.getElementById('log-container').innerHTML = '';
}

/* ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠ ===== */
function playerSelect(move) {
    if (G.phase !== 'select') return;
    G.playerChoice = { type: 'normal', move };
    disableSelect();
    runCpuTurn();
}

function playerSelectOugi(id) {
    if (G.phase !== 'select') return;
    const o = OUGI_DEFS.find(x => x.id === id);
    if (!o) return;
    if (G.player.op < o.cost) { addLog('OPä¸è¶³ã§ã™', 'system'); return; }

    if (id === 11) {
        // ãƒãƒƒã‚­ãƒ³ã‚°ï¼šå…ˆã«CPUæ‰‹ã‚’æ±ºå®šã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¦‹ã›ã‚‹
        const cpuMove = cpuDecide(null); // ãƒ’ãƒ³ãƒˆç„¡ã—
        G.hackingPending = { cpuMove };
        showHackingModal(cpuMove);
        return;
    }

    G.playerChoice = { type: 'ougi', id };
    disableSelect();
    runCpuTurn();
}

/* ===== ãƒãƒƒã‚­ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
function showHackingModal(cpuMove) {
    const modal = document.getElementById('hacking-modal');
    modal.classList.remove('hidden');
    const info = document.getElementById('hacking-enemy-info');
    const moveName = cpuMove.type === 'normal'
        ? `${MOVE_ICONS[cpuMove.move]} ${MOVE_NAMES[cpuMove.move]}`
        : `${OUGI_DEFS.find(o => o.id === cpuMove.id)?.icon} ${OUGI_DEFS.find(o => o.id === cpuMove.id)?.name}`;
    info.textContent = `CPUã®æ‰‹ï¼š${moveName}`;

    const choices = document.getElementById('hacking-choices');
    choices.innerHTML = '';

    // â”€â”€ é€šå¸¸æ‰‹ â”€â”€
    const normalSec = document.createElement('div');
    normalSec.style.cssText = 'grid-column:1/-1;font-size:0.72rem;color:#9070b0;margin-bottom:4px;';
    normalSec.textContent = 'â—† é€šå¸¸æ‰‹';
    choices.appendChild(normalSec);
    ['goo', 'choki', 'pa'].forEach(m => {
        const btn = document.createElement('button');
        btn.className = 'move-btn';
        btn.style.padding = '8px';
        btn.innerHTML = `<span class="icon" style="font-size:1.4rem">${MOVE_ICONS[m]}</span>${MOVE_NAMES[m]}`;
        const sealed = (G.player.seals[m] || 0) > 0;
        btn.disabled = sealed;
        btn.onclick = () => { closeHackingModal(); commitHacking({ type: 'normal', move: m }); };
        choices.appendChild(btn);
    });

    // â”€â”€ å¥¥ç¾© â”€â”€
    const ougiLabel = document.createElement('div');
    ougiLabel.style.cssText = 'grid-column:1/-1;font-size:0.72rem;color:#9070b0;margin:8px 0 4px;';
    ougiLabel.textContent = 'â—† å¥¥ç¾©ï¼ˆOPæ¶ˆè²»ï¼‰';
    choices.appendChild(ougiLabel);
    for (const o of OUGI_DEFS) {
        if (o.id === 11) continue; // ãƒãƒƒã‚­ãƒ³ã‚°ä¸­ã«ãƒãƒƒã‚­ãƒ³ã‚°ã¯ä¸å¯
        const ct = G.player.cts[o.id] || 0;
        const sealed = isOugiSealed(G.player, o);
        const HACK_COST = 15;
        const totalCost = HACK_COST + o.cost;
        const affordable = G.player.op >= totalCost; // ãƒãƒƒã‚­ãƒ³ã‚°15 + å¥¥ç¾©ã‚³ã‚¹ãƒˆ
        const tasogareBlock = (o.id === 10) && G.player.hp > 30;
        const angelBlock = (o.id === 12) && !G.player.angelCondition;
        const unavail = ct > 0 || !affordable || sealed || tasogareBlock || angelBlock;
        const btn = document.createElement('button');
        btn.className = 'ougi-btn';
        btn.style.cssText = 'font-size:0.72rem;';
        btn.innerHTML = `<span class="o-name">${o.icon} ${o.name}</span><span class="o-cost" style="font-size:0.65rem">OP-${totalCost}(15+${o.cost})${ct > 0 ? ` CT${ct}` : ''}</span>`;
        btn.disabled = unavail;
        if (!unavail) {
            btn.onclick = () => { closeHackingModal(); commitHacking({ type: 'ougi', id: o.id }); };
        }
        choices.appendChild(btn);
    }
}
function closeHackingModal() {
    document.getElementById('hacking-modal').classList.add('hidden');
}
function commitHacking(playerMove) {
    G.playerChoice = { type: 'ougi', id: 11, subChoice: playerMove };
    G.enemyChoice = G.hackingPending.cpuMove;
    G.hackingPending = null;
    disableSelect();
    resolveRound();
}

/* ===== CPU AI ===== */
function cpuDecide(hint) {
    const st = G.enemy;
    // åˆ©ç”¨ã§ãã‚‹å¥¥ç¾©ã‚’åé›†
    const available = OUGI_DEFS.filter(o => {
        if ((st.cts[o.id] || 0) > 0) return false;
        if (st.op < o.cost) return false;
        if (isOugiSealed(st, o)) return false;
        if (o.id === 12 && !st.angelCondition) return false;
        return true;
    });

    // é€šå¸¸æ‰‹å€™è£œ
    const normalMoves = ['goo', 'choki', 'pa'].filter(m => (st.seals[m] || 0) === 0);

    const allChoices = [];
    normalMoves.forEach(m => allChoices.push({ type: 'normal', move: m, weight: 3 }));
    available.forEach(o => {
        let w = 1;
        if (o.id === 7) w = st.scienceOn ? 0 : 2; // ãƒˆã‚°ãƒ«OFFæ™‚ã¯å°‘ã—é¸ã¶
        if (o.id === 10 && st.hp > 30) w = 0;      // é»„æ˜ï¼šHP30ä»¥ä¸‹é™å®š
        if (o.id === 12 && st.angelCondition) w = 5;
        if (w > 0) allChoices.push({ type: 'ougi', id: o.id, weight: w });
    });

    if (allChoices.length === 0) {
        // å…¨éƒ¨å°å°â†’ã‚°ãƒ¼å¼·åˆ¶
        return { type: 'normal', move: 'goo' };
    }

    const total = allChoices.reduce((s, c) => s + c.weight, 0);
    let r = Math.random() * total;
    for (const c of allChoices) {
        r -= c.weight;
        if (r <= 0) return c;
    }
    return allChoices[allChoices.length - 1];
}

function runCpuTurn() {
    document.getElementById('cpu-thinking').textContent = 'CPUæ€è€ƒä¸­â€¦';
    setTimeout(() => {
        document.getElementById('cpu-thinking').textContent = '';
        G.enemyChoice = cpuDecide(null);
        resolveRound();
    }, 600);
}

/* ===== ãƒ©ã‚¦ãƒ³ãƒ‰è§£æ±º ===== */
function resolveRound() {
    G.phase = 'result';
    const pc = G.playerChoice;
    const ec = G.enemyChoice;
    const ps = G.player;
    const es = G.enemy;

    addLog(`â”â” ã‚¿ãƒ¼ãƒ³ ${G.turn} â”â”`, 'system');

    // å„ªå…ˆåº¦è¨ˆç®—
    let pPrio = pc.type === 'ougi' ? (OUGI_DEFS.find(o => o.id === pc.id)?.prio || 0) : 0;
    let ePrio = ec.type === 'ougi' ? (OUGI_DEFS.find(o => o.id === ec.id)?.prio || 0) : 0;

    // --- ã‚¨ãƒ³ã‚¸ã‚§ãƒ«éšŠï¼ˆå„ªå…ˆprio=9ï¼šæœ€å„ªå…ˆå‡¦ç†ï¼‰ ---
    let angelPlayer = pc.type === 'ougi' && pc.id === 12 && ps.angelCondition;
    let angelEnemy = ec.type === 'ougi' && ec.id === 12 && es.angelCondition;
    if (angelPlayer || angelEnemy) {
        applyAngel(angelPlayer, angelEnemy);
        return;
    }

    // --- é»„æ˜ å„ªå…ˆå‡¦ç†: ç›¸æ‰‹å¥¥ç¾©ã‚­ãƒ£ãƒ³ã‚»ãƒ« ---
    let yamikumoActive = false;
    if (pc.type === 'ougi' && pc.id === 10 && ps.hp <= 30) {
        if (ec.type === 'ougi') {
            addLog(`${OUGI_DEFS[9].icon} é»„æ˜ ç™ºå‹•ï¼ç›¸æ‰‹å¥¥ç¾©ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼`, 'ougi');
            ec.cancelled = true;
        }
        yamikumoActive = true;
    }
    if (ec.type === 'ougi' && ec.id === 10 && es.hp <= 30) {
        if (pc.type === 'ougi') {
            addLog(`CPU: ${OUGI_DEFS[9].icon} é»„æ˜ ç™ºå‹•ï¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¥¥ç¾©ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼`, 'ougi');
            pc.cancelled = true;
        }
        yamikumoActive = true;
    }

    // --- é«­ãƒ€ãƒ³ãƒ‡ã‚£ï¼ˆå„ªå…ˆprio=3ï¼‰: ç›¸æ‰‹æ‰‹ã‚’å¼·åˆ¶çš„ã«é«­ãƒ€ãƒ³ãƒ‡ã‚£ã¸å¤‰æ›´ ---
    let hiseDandy = null;
    if (pc.type === 'ougi' && pc.id === 9 && !pc.cancelled) hiseDandy = 'player';
    if (ec.type === 'ougi' && ec.id === 9 && !ec.cancelled) hiseDandy = hiseDandy ? 'both' : 'enemy';

    // --- ã‚¸ãƒ£ãƒ³ã‚±ãƒ³çŸ¥ã‚Šã¾ã›ã‚“ï¼ˆå„ªå…ˆprio=5ï¼‰ ---
    let jkPlayer = pc.type === 'ougi' && pc.id === 13 && !pc.cancelled;
    let jkEnemy = ec.type === 'ougi' && ec.id === 13 && !ec.cancelled;

    // ç™ºå‹•è€…OPã‚’æ¶ˆè²»
    consumeOp(pc, ps, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
    consumeOp(ec, es, 'CPU');

    // è¡¨ç¤º
    showHands(pc, ec);

    // é«­ãƒ€ãƒ³ãƒ‡ã‚£å‡¦ç†
    if (hiseDandy) {
        applyHiseDandy(hiseDandy, pc, ec);
        postTurn();
        return;
    }

    // ã‚¸ãƒ£ãƒ³ã‚±ãƒ³çŸ¥ã‚Šã¾ã›ã‚“
    if (jkPlayer && jkEnemy) {
        const pd = randInt(1, 50), ed2 = randInt(1, 50);
        addLog(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ğŸƒ ã‚¸ãƒ£ãƒ³ã‚±ãƒ³çŸ¥ã‚Šã¾ã›ã‚“ â†’ CPUã«${pd}ãƒ€ãƒ¡ï¼`, 'ougi');
        addLog(`CPU: ğŸƒ ã‚¸ãƒ£ãƒ³ã‚±ãƒ³çŸ¥ã‚Šã¾ã›ã‚“ â†’ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«${ed2}ãƒ€ãƒ¡ï¼`, 'ougi');
        applyDmgDirect(es, pd, ps);
        applyDmgDirect(ps, ed2, es);
        setCT(pc, ps); setCT(ec, es);
        postTurn(); return;
    }
    if (jkPlayer) {
        const d = randInt(1, 50);
        addLog(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ğŸƒ ã‚¸ãƒ£ãƒ³ã‚±ãƒ³çŸ¥ã‚Šã¾ã›ã‚“ â†’ CPUã«${d}ãƒ€ãƒ¡ï¼`, 'ougi');
        applyDmgDirect(es, d, ps);
        // ç›¸æ‰‹ã¯é€šå¸¸/ä»–å¥¥ç¾©
        resolveEnemyNormal(pc, ec, ps, es, true);
        setCT(pc, ps); setCT(ec, es);
        postTurn(); return;
    }
    if (jkEnemy) {
        const d = randInt(1, 50);
        addLog(`CPU: ğŸƒ ã‚¸ãƒ£ãƒ³ã‚±ãƒ³çŸ¥ã‚Šã¾ã›ã‚“ â†’ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«${d}ãƒ€ãƒ¡ï¼`, 'ougi');
        applyDmgDirect(ps, d, es);
        resolvePlayerNormal(pc, ec, ps, es, true);
        setCT(pc, ps); setCT(ec, es);
        postTurn(); return;
    }

    // å±æ€§å–å¾—
    const pAttr = getAttr(pc);
    const eAttr = getAttr(ec);

    // å‹æ•—åˆ¤å®šï¼ˆç‰¹æ®Šå±æ€§ã¯å…¨å±æ€§ã«ä¸åˆ©â†’å…¨é€šå¸¸æ‰‹ã«è² ã‘ï¼‰
    const result = judgeResult(pAttr, eAttr);
    addLog(`å‹æ•—: ${result === 'player' ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‹åˆ©' : result === 'enemy' ? 'CPUå‹åˆ©' : 'ã‚ã„ã“'}`, 'system');

    // å„å¥¥ç¾©ã®å›ºæœ‰å‡¦ç†ã‚’å®Ÿè¡Œ
    processOugiEffects(pc, ec, ps, es, result);

    postTurn();
}

function getAttr(choice) {
    if (choice.type === 'normal') return choice.move;
    if (choice.type === 'ougi') {
        if (choice.cancelled) return choice.subChoice ? choice.subChoice.move : 'goo';
        return OUGI_DEFS.find(o => o.id === choice.id)?.attr || 'goo';
    }
    return 'goo';
}

function judgeResult(pAttr, eAttr) {
    if (pAttr === eAttr) return 'draw';
    // ç‰¹æ®Šå±æ€§ã¯é€šå¸¸ä¸‰ã™ãã¿ã«è² ã‘
    if (pAttr === 'special' && eAttr !== 'special') return 'enemy';
    if (eAttr === 'special' && pAttr !== 'special') return 'player';
    // ä¸¡æ–¹ç‰¹æ®Šâ†’ã‚ã„ã“
    if (pAttr === 'special' && eAttr === 'special') return 'draw';
    // é€šå¸¸ä¸‰ã™ãã¿
    if (BEATS[pAttr] === eAttr) return 'player';
    if (BEATS[eAttr] === pAttr) return 'enemy';
    return 'draw';
}

function processOugiEffects(pc, ec, ps, es, result) {
    // é»„æ˜ï¼šé€šå¸¸æ‰‹ç›¸æ‰‹ãªã‚‰è‡ªå‚·5
    if (pc.type === 'ougi' && pc.id === 10 && ps.hp <= 30 && !pc.cancelled) {
        applyHeal(ps, 5, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'); changeOP(ps, 5, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
        if (ec.type === 'normal') {
            addLog('é»„æ˜ï¼šé€šå¸¸æ‰‹ç›¸æ‰‹ã®ãŸã‚è‡ªå‚·5ï¼', 'damage');
            applyDmgDirect(ps, 5, es);
        }
    }
    if (ec.type === 'ougi' && ec.id === 10 && es.hp <= 30 && !ec.cancelled) {
        applyHeal(es, 5, 'CPU'); changeOP(es, 5, 'CPU');
        if (pc.type === 'normal') {
            addLog('CPU é»„æ˜ï¼šé€šå¸¸æ‰‹ç›¸æ‰‹ã®ãŸã‚è‡ªå‚·5ï¼', 'damage');
            applyDmgDirect(es, 5, ps);
        }
    }

    // ã‚¸ãƒ£ãƒƒã‚«ãƒ«
    if (pc.type === 'ougi' && pc.id === 1 && !pc.cancelled) applyJackal(ps, es, result, ec, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
    if (ec.type === 'ougi' && ec.id === 1 && !ec.cancelled) applyJackal(es, ps, flipResult(result), pc, 'CPU');

    // ç†±æ„›ç™ºè¦š
    if (pc.type === 'ougi' && pc.id === 2 && !pc.cancelled) applyHotai(ps, es, result, getAttr(ec), 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
    if (ec.type === 'ougi' && ec.id === 2 && !ec.cancelled) applyHotai(es, ps, flipResult(result), getAttr(pc), 'CPU');

    // ãƒãƒã®å‘³
    if (pc.type === 'ougi' && pc.id === 3 && !pc.cancelled) applyMama(ps, es, getAttr(ec), 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
    if (ec.type === 'ougi' && ec.id === 3 && !ec.cancelled) applyMama(es, ps, getAttr(pc), 'CPU');

    // ç´„æŸã®æ—¥
    if (pc.type === 'ougi' && pc.id === 4 && !pc.cancelled) applyYakusoku(ps, es, result, getAttr(ec), 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
    if (ec.type === 'ougi' && ec.id === 4 && !ec.cancelled) applyYakusoku(es, ps, flipResult(result), getAttr(pc), 'CPU');

    // è²·å
    if (pc.type === 'ougi' && pc.id === 5 && !pc.cancelled) applyKaishuu(ps, es, getAttr(ec), 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
    if (ec.type === 'ougi' && ec.id === 5 && !ec.cancelled) applyKaishuu(es, ps, getAttr(pc), 'CPU');

    // è¦ªå‹
    if (pc.type === 'ougi' && pc.id === 6 && !pc.cancelled) applyShinyuu(ps, es, result, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
    if (ec.type === 'ougi' && ec.id === 6 && !ec.cancelled) applyShinyuu(es, ps, flipResult(result), 'CPU');

    // è¶…é«˜é€Ÿç ´å£Šæ‹³
    if (pc.type === 'ougi' && pc.id === 8 && !pc.cancelled) applyChokosoku(ps, es, getAttr(ec), 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
    if (ec.type === 'ougi' && ec.id === 8 && !ec.cancelled) applyChokosoku(es, ps, getAttr(pc), 'CPU');

    // é€šå¸¸å‹æ•—ãƒ€ãƒ¡ï¼ˆå¥¥ç¾©ãŒè¦†ã‚ãªã„å ´åˆï¼‰
    const pIsNormal = pc.type === 'normal' || pc.cancelled;
    const eIsNormal = ec.type === 'normal' || ec.cancelled;
    const pSpecial = !pIsNormal && isSpecialOugi(pc.id);
    const eSpecial = !eIsNormal && isSpecialOugi(ec.id);

    if ((pIsNormal || pSpecial) && (eIsNormal || eSpecial)) {
        // å¥¥ç¾©ãŒå›ºæœ‰ãƒ€ãƒ¡ã‚’æŒãŸãªã„å ´åˆã®é€šå¸¸åˆ¤å®š
        if (result === 'player') {
            changeOP(ps, 2, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
            applyDmg(es, ps, 2, 'CPU');
        } else if (result === 'enemy') {
            changeOP(es, 2, 'CPU');
            applyDmg(ps, es, 2, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
        } else {
            changeOP(ps, 1, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'); changeOP(es, 1, 'CPU');
            addLog('ã‚ã„ã“ï¼ä¸¡è€…OP+1', 'system');
        }
    }

    // ç§‘å­¦åŠ›ã‚ªãƒ³å´ã®è¿½åŠ ãƒ€ãƒ¡
    if (ps.scienceOn) {
        addLog('ç§‘å­¦åŠ›ï¼šCPUã«è¿½åŠ 3ãƒ€ãƒ¡', 'damage');
        applyDmgDirect(es, 3, ps);
    }
    if (es.scienceOn) {
        addLog('CPU ç§‘å­¦åŠ›ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿½åŠ 3ãƒ€ãƒ¡', 'damage');
        applyDmgDirect(ps, 3, es);
    }

    // CTæ›´æ–°
    setCT(pc, ps); setCT(ec, es);
    // å¥¥ç¾©ä½¿ç”¨è¨˜éŒ²ï¼ˆã‚¨ãƒ³ã‚¸ã‚§ãƒ«éšŠæ¡ä»¶ï¼‰
    if (pc.type === 'ougi' && !pc.cancelled) { ps.usedOugiIds.add(pc.id); checkAngelCondition(ps); }
    if (ec.type === 'ougi' && !ec.cancelled) { es.usedOugiIds.add(ec.id); checkAngelCondition(es); }
}

function isSpecialOugi(id) {
    return [7, 9, 10, 11, 12, 13].includes(id);
}

function flipResult(r) { return r === 'player' ? 'enemy' : r === 'enemy' ? 'player' : 'draw'; }

/* ===== å¥¥ç¾©å€‹åˆ¥å®Ÿè£… ===== */
function applyJackal(self, opp, result, oppChoice, who) {
    const eAttr = getAttr(oppChoice);
    addLog(`${who}: ğŸº ã‚¸ãƒ£ãƒƒã‚«ãƒ«ç™ºå‹•ï¼`, 'ougi');
    // ã‚°ãƒ¼ã«è² ã‘ç¢ºå®šï¼ˆå±æ€§åˆ¤å®šã¯ goo vs chokiï¼‰
    if (eAttr === 'goo') {
        // è² ã‘ï¼šé€šå¸¸æ•—åŒ—ãƒ€ãƒ¡
        changeOP(opp, 2, who === 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' ? 'CPU' : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
        applyDmg(self, opp, 2, who);
    } else if (eAttr === 'choki') {
        applyDmgDirect(opp, 3, self);
        addLog(`${who} â†’ ç›¸æ‰‹ã«3ãƒ€ãƒ¡(ãƒãƒ§ã‚­)`, 'damage');
    } else {
        applyDmgDirect(opp, 5, self);
        addLog(`${who} â†’ ç›¸æ‰‹ã«5ãƒ€ãƒ¡(ãƒ‘ãƒ¼/ç‰¹æ®Š)`, 'damage');
    }
}

function applyHotai(self, opp, result, oppAttr, who) {
    addLog(`${who}: ğŸ’˜ ç†±æ„›ç™ºè¦šï¼`, 'ougi');
    if (result === 'enemy' || (result === 'draw' && false)) {
        // è‡ªåˆ†ãŒè² ã‘â†’è‡ªåˆ†ã®ã‚°ãƒ¼å°å°
        self.seals['goo'] = 3;
        addLog(`${who}ãŒã‚°ãƒ¼å±æ€§ã‚’ï¼“ã‚¿ãƒ¼ãƒ³å°å°ã•ã‚ŒãŸï¼`, 'damage');
    } else {
        // å‹ã¡ã¾ãŸã¯ã‚ã„ã“â†’ç›¸æ‰‹ã®å‡ºã—ãŸå±æ€§ã®ãŒ·ã®ã¿ï¼“ã‚¿ãƒ¼ãƒ³å°å°
        if (opp.seals[oppAttr] !== undefined) {
            opp.seals[oppAttr] = 3;
            addLog(`ç›¸æ‰‹ã®${ATTR_LABEL[oppAttr]}ã®æ‰‹ã‚’ï¼“ã‚¿ãƒ¼ãƒ³å°å°ï¼`, 'damage');
        }
    }
}

function applyMama(self, opp, oppAttr, who) {
    addLog(`${who}: ğŸ± ãƒãƒã®å‘³ç™ºå‹•ï¼`, 'ougi');
    applyHeal(self, 10, who);
    if (oppAttr === 'pa') {
        applyHeal(opp, 10, who === 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' ? 'CPU' : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
        addLog('ç›¸æ‰‹ã®ãƒ‘ãƒ¼ã«ã‚ˆã‚Šä¸¡è€…HP+10ï¼', 'heal');
    }
}

function applyYakusoku(self, opp, result, oppAttr, who) {
    addLog(`${who}: ğŸ“… ç´„æŸã®æ—¥ç™ºå‹•ï¼`, 'ougi');
    if (oppAttr === 'goo') {
        // è² ã‘ç¢ºå®š
        changeOP(opp, 2, who === 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' ? 'CPU' : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
        applyDmg(self, opp, 2, who);
    } else {
        // æ¬¡ã®è¢«ãƒ€ãƒ¡ç„¡åŠ¹
        self.shieldNext = true;
        addLog(`${who}ï¼šæ¬¡ã®è¢«ãƒ€ãƒ¡ã‚’ç„¡åŠ¹åŒ–ï¼`, 'buff');
    }
}

function applyKaishuu(self, opp, oppAttr, who) {
    addLog(`${who}: ğŸ’´ è²·åç™ºå‹•ï¼`, 'ougi');
    if (oppAttr === 'choki') {
        addLog(`ãƒãƒ§ã‚­ç›¸æ‰‹ã®ãŸã‚ç„¡åŠ¹`, 'system');
        return;
    }
    self.hp -= 15; self.hp = Math.max(0, self.hp);
    addLog(`${who}ï¼šè‡ªåˆ†HP-15`, 'damage');
    const gain = Math.min(15, self.maxOp - self.op);
    self.op += gain;
    addLog(`${who}ï¼šOP+${gain}`, 'heal');
}

function applyShinyuu(self, opp, result, who) {
    addLog(`${who}: ğŸ¤ è¦ªå‹ç™ºå‹•ï¼ãƒãƒ§ã‚­ã«è² ã‘`, 'ougi');
    // ãƒ€ãƒ¡ãƒ¼ã‚¸å…±æœ‰ãƒ•ãƒ©ã‚°ï¼ˆã“ã®ã‚¿ãƒ¼ãƒ³ã¯é€šå¸¸ãƒ€ãƒ¡ã‚’å…±æœ‰ï¼‰
    // ãƒãƒ§ã‚­ã«è² ã‘ç¢ºå®šï¼ˆè¦ªå‹ã®attr=paã€ãƒãƒ§ã‚­ã¯paã«å‹ã¤ï¼‰
    // é€šå¸¸ãƒ€ãƒ¡ã‚’ä¸¡è€…ã«é©ç”¨
    self.sharedDmg = true;
}

function applyChokosoku(self, opp, oppAttr, who) {
    addLog(`${who}: ğŸ‘Š è¶…é«˜é€Ÿç ´å£Šæ‹³ç™ºå‹•ï¼`, 'ougi');
    if (oppAttr === 'pa') {
        addLog(`ãƒ‘ãƒ¼ã«30ãƒ€ãƒ¡ï¼`, 'ougi');
        applyDmgDirect(opp, 30, self);
    } else {
        addLog(`ãƒ‘ãƒ¼ä»¥å¤–ã¸ã®ä½¿ç”¨â€¦è‡ªæ»…ï¼`, 'damage');
        self.hp = 0;
        const ougiDef = OUGI_DEFS.find(o => o.id === 8);
        self.cts[8] = (self.cts[8] || 0) + 2; // CT+2ãƒšãƒŠãƒ«ãƒ†ã‚£
    }
}

function applyHiseDandy(side, pc, ec) {
    // é«­ãƒ€ãƒ³ãƒ‡ã‚£ã‚’ç™ºå‹•ã—ãŸå´ï¼šç›¸æ‰‹ã®æ‰‹ã‚’å¼·åˆ¶çš„ã«é«­ãƒ€ãƒ³ãƒ‡ã‚£ã«å¤‰æ›´ï¼ˆç›¸æ‰‹ã‚‚OPæ¶ˆè²»ï¼‰
    const HISE_COST = 4; // é«­ãƒ€ãƒ³ãƒ‡ã‚£ã®ã‚³ã‚¹ãƒˆ

    if (side === 'player' || side === 'both') {
        addLog(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ğŸ¥¸ é«­ãƒ€ãƒ³ãƒ‡ã‚£ç™ºå‹•ï¼CPUã®æ‰‹ã‚’å¼·åˆ¶çš„ã«é«­ãƒ€ãƒ³ãƒ‡ã‚£ã«å¤‰æ›´ï¼`, 'ougi');
        // CPUã®OPæ¶ˆè²»å‡¦ç†
        if (G.enemy.op >= HISE_COST) {
            G.enemy.op -= HISE_COST;
            addLog(`CPU: å¼·åˆ¶ç™ºå‹•ï¼ˆOP-${HISE_COST}ï¼‰`, 'ougi');
        } else {
            addLog(`CPU: OPä¸è¶³ã®ãŸã‚OPâ†’0`, 'damage');
            G.enemy.op = 0;
        }
        // CPUã®æ‰‹ã‚’é«­ãƒ€ãƒ³ãƒ‡ã‚£ã«ä¸Šæ›¸ã
        G.enemyChoice = { type: 'ougi', id: 9, forcedByOpponent: true };
        // CTè¨­å®š
        G.enemy.cts[9] = OUGI_DEFS.find(o => o.id === 9).ct;
        G.enemy.usedOugiIds.add(9); checkAngelCondition(G.enemy);
    }
    if (side === 'enemy' || side === 'both') {
        addLog(`CPU: ğŸ¥¸ é«­ãƒ€ãƒ³ãƒ‡ã‚£ç™ºå‹•ï¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ã‚’å¼·åˆ¶çš„ã«é«­ãƒ€ãƒ³ãƒ‡ã‚£ã«å¤‰æ›´ï¼`, 'ougi');
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®OPæ¶ˆè²»å‡¦ç†
        if (G.player.op >= HISE_COST) {
            G.player.op -= HISE_COST;
            addLog(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: å¼·åˆ¶ç™ºå‹•ï¼ˆOP-${HISE_COST}ï¼‰`, 'ougi');
        } else {
            addLog(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: OPä¸è¶³ã®ãŸã‚OPâ†’0`, 'damage');
            G.player.op = 0;
        }
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ã‚’é«­ãƒ€ãƒ³ãƒ‡ã‚£ã«ä¸Šæ›¸ã
        G.playerChoice = { type: 'ougi', id: 9, forcedByOpponent: true };
        G.player.cts[9] = OUGI_DEFS.find(o => o.id === 9).ct;
        G.player.usedOugiIds.add(9); checkAngelCondition(G.player);
    }

    // ä¸¡è€…ãŒé«­ãƒ€ãƒ³ãƒ‡ã‚£ â†’ ã‚ã„ã“æ‰±ã„ï¼ˆOP+1ï¼‰
    addLog('ä¸¡è€… ğŸ¥¸ é«­ãƒ€ãƒ³ãƒ‡ã‚£ â†’ ã‚ã„ã“ï¼ä¸¡è€…OP+1', 'system');
    changeOP(G.player, 1, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'); changeOP(G.enemy, 1, 'CPU');

    // å…ƒã®ç™ºå‹•è€…ã®CTãƒ»å¥¥ç¾©è¨˜éŒ²
    setCT(pc, G.player); setCT(ec, G.enemy);
    if (pc.type === 'ougi' && !pc.forcedByOpponent) { G.player.usedOugiIds.add(pc.id); checkAngelCondition(G.player); }
    if (ec.type === 'ougi' && !ec.forcedByOpponent) { G.enemy.usedOugiIds.add(ec.id); checkAngelCondition(G.enemy); }
}

function applyAngel(forPlayer, forEnemy) {
    addLog('ğŸ‘¼ ã‚¨ãƒ³ã‚¸ã‚§ãƒ«éšŠç™ºå‹•ï¼å…¨çŠ¶æ…‹ã‚’åˆæœŸåŒ–ï¼', 'ougi');
    const resetState = (st) => {
        st.hp = 1; st.op = 0;
        st.seals = { goo: 0, choki: 0, pa: 0, special: 0 };
        Object.keys(st.cts).forEach(k => st.cts[k] = 99);
        st.scienceOn = false; st.shieldNext = false; st.sharedDmg = false;
        st.angelCondition = false;
    };
    resetState(G.player); resetState(G.enemy);
    G.phase = 'select';
    G.turn++;
    renderUI(); renderOugiGrid(); enableSelect();
    showHands({ type: 'ougi', id: 12 }, { type: 'ougi', id: 12 });
    document.getElementById('result-banner').textContent = 'âœ¨ ã‚¨ãƒ³ã‚¸ã‚§ãƒ«éšŠ âœ¨';
    document.getElementById('result-banner').className = 'result-banner draw';
    document.getElementById('result-banner').style.opacity = '1';
    return;
}

/* ===== ç§‘å­¦åŠ›ãƒˆã‚°ãƒ« ===== */
function applyScienceToggle(st, who) {
    st.scienceOn = !st.scienceOn;
    addLog(`${who}: ğŸ”¬ ç§‘å­¦åŠ›${st.scienceOn ? 'ON' : 'OFF'}`, 'ougi');
}

/* ===== HP/OPæ“ä½œ ===== */
function applyDmg(victim, attacker, amount, victimName) {
    if (victim.shieldNext) {
        addLog(`${victimName}ï¼šè¢«ãƒ€ãƒ¡ç„¡åŠ¹ï¼`, 'buff');
        victim.shieldNext = false;
        return;
    }
    if (victim.sharedDmg) {
        const half = Math.ceil(amount / 2);
        victim.hp -= half; victim.hp = Math.max(0, victim.hp);
        attacker.hp -= half; attacker.hp = Math.max(0, attacker.hp);
        addLog(`è¦ªå‹ï¼šãƒ€ãƒ¡ãƒ¼ã‚¸${amount}ã‚’å…±æœ‰ï¼ˆå„${half}ï¼‰`, 'damage');
        return;
    }
    victim.hp -= amount; victim.hp = Math.max(0, victim.hp);
    addLog(`${victimName}ã«${amount}ãƒ€ãƒ¡ï¼`, 'damage');
}

function applyDmgDirect(victim, amount, attacker) {
    // é˜²å¾¡ç„¡åŠ¹ or é€šå¸¸ï¼ˆã‚·ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯ã—ãªã„ç‰ˆï¼‰
    victim.hp -= amount; victim.hp = Math.max(0, victim.hp);
}

function applyHeal(target, amount, who) {
    target.hp = Math.min(target.maxHp, target.hp + amount);
    addLog(`${who}ï¼šHP+${amount}`, 'heal');
}

function changeOP(st, delta, who) {
    st.op = Math.max(0, Math.min(st.maxOp, st.op + delta));
}

/* ===== CTç®¡ç† ===== */
function setCT(choice, st) {
    if (choice.type === 'ougi' && choice.id !== 7) {
        const o = OUGI_DEFS.find(x => x.id === choice.id);
        if (o) st.cts[o.id] = o.ct;
    }
}

/* ===== ã‚¨ãƒ³ã‚¸ã‚§ãƒ«éšŠæ¡ä»¶ ===== */
function checkAngelCondition(st) {
    // æ¡ä»¶å¥¥ç¾©ï¼šã‚¸ãƒ£ãƒƒã‚«ãƒ«/ç†±æ„›ç™ºè¦š/ãƒãƒã®å‘³/ç´„æŸã®æ—¥/è²·å/é«­ãƒ€ãƒ³ãƒ‡ã‚£/ãƒãƒƒã‚­ãƒ³ã‚°
    const condIds = [1, 2, 3, 4, 5, 9, 11];
    if (condIds.every(id => st.usedOugiIds.has(id))) {
        if (!st.angelCondition) {
            st.angelCondition = true;
            addLog('ğŸ”” ã‚¨ãƒ³ã‚¸ã‚§ãƒ«éšŠã®ç™ºå‹•æ¡ä»¶ã‚’é”æˆï¼', 'ougi');
        }
    }
}

/* ===== é€šå¸¸/ä»–ã®å¥¥ç¾©ã®å‡¦ç†ï¼ˆJKçŸ¥ã‚Šã¾ã›ã‚“ç‰‡å´ï¼‰===== */
function resolveEnemyNormal(pc, ec, ps, es, skipNormal) { }
function resolvePlayerNormal(pc, ec, ps, es, skipNormal) { }

/* ===== ã‚¿ãƒ¼ãƒ³å¾Œå‡¦ç† ===== */
function postTurn() {
    // ç§‘å­¦åŠ›æ¯ã‚¿ãƒ¼ãƒ³å‡¦ç†
    [['player', G.player, G.enemy], ['enemy', G.enemy, G.player]].forEach(([who, st, opp]) => {
        if (st.scienceOn) {
            if (st.op >= 5) {
                st.op -= 5; addLog(`${who === 'player' ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'CPU'} ç§‘å­¦åŠ›ï¼šOP-5`, 'system');
            } else {
                const lack = 5 - st.op; st.op = 0; st.hp -= lack; st.hp = Math.max(0, st.hp);
                addLog(`${who === 'player' ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'CPU'} ç§‘å­¦åŠ›ï¼šOPä¸è¶³! HP-${lack}`, 'damage');
            }
        }
    });

    // CTæ¸›ç®—ãƒ»å°å°æ›´æ–°
    [G.player, G.enemy].forEach(st => {
        for (const k in st.cts) { if (st.cts[k] > 0) st.cts[k]--; }
        for (const attr in st.seals) { if (st.seals[attr] > 0) st.seals[attr]--; }
        st.sharedDmg = false; // æ¯ã‚¿ãƒ¼ãƒ³ã‚¯ãƒªã‚¢
    });

    // OPè‡ªç„¶å¢—åŠ ï¼ˆé€šå¸¸æ‰‹ã®ã¨ãï¼‰
    [['player', G.player, G.playerChoice], ['enemy', G.enemy, G.enemyChoice]].forEach(([who, st, ch]) => {
        if (ch && ch.type === 'normal') {
            // é€šå¸¸åˆ¤å®šã§ã®OPå¢—åŠ ã¯processOugiEffectså†…ã§å‡¦ç†æ¸ˆã¿
            // ãŸã ã—å¥¥ç¾©é¸æŠæ™‚ã¯æ¶ˆè²»ã®ã¿
        }
    });

    renderUI();
    checkGameOver();

    if (G.phase !== 'over') {
        G.turn++;
        G.phase = 'select';
        G.playerChoice = null;
        G.enemyChoice = null;
        enableSelect();
    }
}

/* ===== æ‰‹ã®è¡¨ç¤º ===== */
function showHands(pc, ec) {
    const pEl = document.getElementById('p-hand-shown');
    const eEl = document.getElementById('e-hand-shown');

    const getIcon = (c) => {
        if (!c) return 'â“';
        if (c.type === 'normal') return MOVE_ICONS[c.move];
        const o = OUGI_DEFS.find(x => x.id === c.id);
        return o?.icon || 'â“';
    };
    const getName = (c) => {
        if (!c) return '?';
        if (c.type === 'normal') return MOVE_NAMES[c.move];
        const o = OUGI_DEFS.find(x => x.id === c.id);
        return o?.name || '?';
    };

    pEl.innerHTML = `<span class="hand-icon">${getIcon(pc)}</span><div class="hand-name">${getName(pc)}</div>`;
    eEl.innerHTML = `<span class="hand-icon">${getIcon(ec)}</span><div class="hand-name">${getName(ec)}</div>`;
    pEl.classList.add('reveal'); eEl.classList.add('reveal');
    setTimeout(() => { pEl.classList.remove('reveal'); eEl.classList.remove('reveal'); }, 600);
}

/* ===== OPæ¶ˆè²» ===== */
function consumeOp(choice, st, who) {
    if (choice.type === 'ougi') {
        const o = OUGI_DEFS.find(x => x.id === choice.id);
        if (o) {
            if (o.id === 7) {
                // ç§‘å­¦åŠ›ï¼šãƒˆã‚°ãƒ«ï¼ˆæ¶ˆè²»3ï¼‰
                applyScienceToggle(st, who);
                st.op = Math.max(0, st.op - o.cost);
                setCT(choice, st);
                return;
            }
            st.op = Math.max(0, st.op - o.cost);
            addLog(`${who}: ${o.icon}${o.name} ç™ºå‹•ï¼ˆOP-${o.cost}ï¼‰`, 'ougi');
        }
    }
}

/* ===== å‹æ•—ãƒã‚§ãƒƒã‚¯ ===== */
function checkGameOver() {
    const pDead = G.player.hp <= 0;
    const eDead = G.enemy.hp <= 0;
    if (!pDead && !eDead) return;
    G.phase = 'over';
    const overlay = document.getElementById('gameover-overlay');
    const title = document.getElementById('gameover-title');
    const sub = document.getElementById('gameover-sub');
    overlay.classList.remove('hidden');

    if (pDead && eDead) {
        title.textContent = 'ç›¸æ‰“ã¡...'; title.className = 'gameover-title draw';
        sub.textContent = 'ä¸¡è€…åŒæ™‚ã«åŠ›å°½ããŸï¼';
    } else if (eDead) {
        title.textContent = 'å‹åˆ©ï¼'; title.className = 'gameover-title win';
        sub.textContent = `ã‚¿ãƒ¼ãƒ³ ${G.turn} â€” å¥¥ç¾©ã‚’åˆ¶ã—ãŸï¼`;
    } else {
        title.textContent = 'æ•—åŒ—...'; title.className = 'gameover-title lose';
        sub.textContent = `ã‚¿ãƒ¼ãƒ³ ${G.turn} â€” å†æŒ‘æˆ¦ã›ã‚ˆï¼`;
    }
    addLog(pDead && eDead ? 'ç›¸æ‰“ã¡ï¼' : eDead ? 'ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‹åˆ©ï¼' : 'ğŸ’€ CPUã®å‹åˆ©â€¦', 'system');

    // ãƒãƒŠãƒ¼æ›´æ–°
    const banner = document.getElementById('result-banner');
    banner.textContent = (pDead && eDead) ? 'ç›¸æ‰“ã¡' : eDead ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‹åˆ©ï¼' : 'CPUå‹åˆ©...';
    banner.className = 'result-banner ' + (pDead && eDead ? 'draw' : eDead ? 'win' : 'lose');
    banner.style.opacity = '1';
    showHands(G.playerChoice, G.enemyChoice);
}

/* ===== ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ ===== */
function restartGame() {
    document.getElementById('gameover-overlay').classList.add('hidden');
    document.getElementById('result-banner').style.opacity = '0';
    document.getElementById('p-hand-shown').innerHTML = '<span class="hand-icon">â“</span><div class="hand-name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>';
    document.getElementById('e-hand-shown').innerHTML = '<span class="hand-icon">â“</span><div class="hand-name">CPU</div>';
    initGame();
}

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

/* ===== ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— ===== */
function initTooltip() {
    const tip = document.getElementById('ougi-tooltip');
    if (!tip) return;
    let hideTimer = null;

    function showTip(el, text) {
        clearTimeout(hideTimer);
        tip.textContent = text;
        tip.style.display = 'block';
        positionTip(el);
    }
    function hideTip() {
        hideTimer = setTimeout(() => { tip.style.display = 'none'; }, 80);
    }
    function positionTip(el) {
        const rect = el.getBoundingClientRect();
        const sw = window.innerWidth, sh = window.innerHeight;
        let left = rect.left + window.scrollX;
        let top = rect.top + window.scrollY - tip.offsetHeight - 8;
        if (top < window.scrollY + 4) top = rect.bottom + window.scrollY + 8;
        if (left + tip.offsetWidth > sw - 8) left = sw - tip.offsetWidth - 8;
        if (left < 4) left = 4;
        tip.style.left = left + 'px';
        tip.style.top = top + 'px';
    }

    // ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼šã‚¤ãƒ™ãƒ³ãƒˆå§”è­²
    document.addEventListener('mouseover', e => {
        const btn = e.target.closest('[data-tip]');
        if (btn) showTip(btn, btn.dataset.tip);
    });
    document.addEventListener('mouseout', e => {
        const btn = e.target.closest('[data-tip]');
        if (btn) hideTip();
    });
    // ã‚¿ãƒƒãƒå¯¾å¿œ
    document.addEventListener('touchstart', e => {
        const btn = e.target.closest('[data-tip]');
        if (btn) { showTip(btn, btn.dataset.tip); }
    }, { passive: true });
    document.addEventListener('touchend', () => hideTip(), { passive: true });
}

/* ===== ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å±æ€§ä»˜ä¸ï¼ˆå¥¥ç¾©ãƒœã‚¿ãƒ³ç”Ÿæˆå¾Œã«å‘¼ã¶ï¼‰ ===== */
function attachTips() {
    // å¥¥ç¾©ãƒœã‚¿ãƒ³ã¸ã®data-tipä»˜ä¸ã¯renderOugiGridå†…ã§å®Ÿæ–½
}

/* ===== èµ·å‹• ===== */
initGame();
initTooltip();

<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¸ãƒ£ãƒ³ã‚±ãƒ³åä¸‰å¥¥ç¾©</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            background: linear-gradient(135deg, #0a0015 0%, #120025 40%, #0d001a 100%);
            min-height: 100vh;
            font-family: 'Noto Sans JP', sans-serif;
            color: #e8d5ff;
            overflow-x: hidden
        }

        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Ccircle cx='50' cy='80' r='1' fill='%23aa66ff' opacity='0.3'/%3E%3Ccircle cx='150' cy='30' r='1.5' fill='%2366aaff' opacity='0.25'/%3E%3Ccircle cx='250' cy='120' r='1' fill='%23ff66aa' opacity='0.2'/%3E%3Ccircle cx='80' cy='200' r='1' fill='%23aa66ff' opacity='0.3'/%3E%3Ccircle cx='220' cy='250' r='1.5' fill='%2366ffaa' opacity='0.2'/%3E%3C/svg%3E") repeat;
            pointer-events: none;
            z-index: 0
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1000px;
            margin: 0 auto;
            padding: 16px
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            text-align: center;
            padding: 20px 0 14px
        }

        header h1 {
            font-size: 2.2rem;
            font-weight: 900;
            background: linear-gradient(90deg, #c066ff, #6699ff, #ff66cc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            letter-spacing: 0.05em
        }

        header p {
            color: #a080c0;
            font-size: 0.85rem;
            margin-top: 4px
        }

        /* ãƒãƒˆãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
        .battlefield {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            align-items: center;
            margin-bottom: 14px;
            max-width: 720px;
            margin-left: auto;
            margin-right: auto
        }

        .player-panel {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(180, 100, 255, 0.2);
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(12px);
            transition: transform 0.3s
        }

        .player-panel.player {
            border-color: rgba(100, 180, 255, 0.3)
        }

        .player-panel.enemy {
            border-color: rgba(255, 100, 180, 0.3)
        }

        .player-panel.damage-flash {
            animation: damageFlash 0.5s ease
        }

        .player-panel.heal-flash {
            animation: healFlash 0.5s ease
        }

        @keyframes damageFlash {

            0%,
            100% {
                background: rgba(255, 255, 255, 0.04)
            }

            50% {
                background: rgba(255, 50, 50, 0.25)
            }
        }

        @keyframes healFlash {

            0%,
            100% {
                background: rgba(255, 255, 255, 0.04)
            }

            50% {
                background: rgba(50, 255, 100, 0.2)
            }
        }

        .panel-name {
            font-size: 0.8rem;
            color: #9080b0;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 0.1em
        }

        .panel-hp,
        .panel-op {
            margin-bottom: 8px
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 3px
        }

        .bar-track {
            height: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08)
        }

        .bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.4s cubic-bezier(.4, 0, .2, 1)
        }

        .hp-fill {
            background: linear-gradient(90deg, #ff4466, #ff8855)
        }

        .op-fill {
            background: linear-gradient(90deg, #6644ff, #aa44ff)
        }

        .hp-fill.low {
            background: linear-gradient(90deg, #ff2200, #ff6600);
            animation: hpPulse 1s infinite
        }

        @keyframes hpPulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.6
            }
        }

        .status-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
            min-height: 20px
        }

        .tag {
            font-size: 0.68rem;
            padding: 2px 6px;
            border-radius: 8px;
            border: 1px solid;
            font-weight: 700
        }

        .tag-seal {
            background: rgba(255, 50, 50, 0.15);
            border-color: #ff5050;
            color: #ff8080
        }

        .tag-buff {
            background: rgba(100, 255, 100, 0.12);
            border-color: #50ff80;
            color: #80ff80
        }

        .tag-debuff {
            background: rgba(255, 100, 50, 0.12);
            border-color: #ff8050;
            color: #ffb080
        }

        .tag-science {
            background: rgba(100, 100, 255, 0.15);
            border-color: #8080ff;
            color: #aaaaff
        }

        .tag-shield {
            background: rgba(50, 200, 255, 0.15);
            border-color: #50ccff;
            color: #80ddff
        }

        .vs-block {
            text-align: center
        }

        .vs-text {
            font-size: 1.8rem;
            font-weight: 900;
            color: #c066ff;
            text-shadow: 0 0 20px #c066ff88
        }

        .turn-num {
            font-size: 0.75rem;
            color: #806090;
            margin-top: 4px
        }

        /* æ‰‹è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .hands-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(150, 80, 255, 0.15);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 14px;
            min-height: 72px;
            max-width: 720px;
            margin-left: auto;
            margin-right: auto
        }

        .hand-shown {
            text-align: center
        }

        .hand-shown .hand-icon {
            font-size: 2.5rem;
            display: block;
            transition: transform 0.3s
        }

        .hand-shown .hand-name {
            font-size: 0.7rem;
            color: #9070b0;
            margin-top: 2px
        }

        .hand-shown.reveal {
            animation: revealHand 0.5s cubic-bezier(.17, .67, .83, .67)
        }

        @keyframes revealHand {
            0% {
                transform: scale(0) rotate(-20deg);
                opacity: 0
            }

            100% {
                transform: scale(1) rotate(0);
                opacity: 1
            }
        }

        .result-banner {
            font-size: 1rem;
            font-weight: 900;
            padding: 6px 18px;
            border-radius: 20px;
            text-align: center
        }

        .result-banner.win {
            background: rgba(80, 255, 120, 0.15);
            border: 1px solid #50ff80;
            color: #80ffaa
        }

        .result-banner.lose {
            background: rgba(255, 50, 80, 0.12);
            border: 1px solid #ff5060;
            color: #ff8090
        }

        .result-banner.draw {
            background: rgba(200, 180, 255, 0.1);
            border: 1px solid #c0b0ff;
            color: #d0c0ff
        }

        /* ãƒãƒˆãƒ«ãƒ­ã‚° */
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(120, 60, 200, 0.2);
            border-radius: 12px;
            padding: 10px 14px;
            margin-bottom: 14px;
            height: 120px;
            overflow-y: auto;
            font-size: 0.78rem;
            line-height: 1.7
        }

        .log-container::-webkit-scrollbar {
            width: 4px
        }

        .log-container::-webkit-scrollbar-track {
            background: transparent
        }

        .log-container::-webkit-scrollbar-thumb {
            background: #6040a0;
            border-radius: 2px
        }

        .log-line {
            padding: 1px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04)
        }

        .log-line:last-child {
            border-bottom: none
        }

        .log-player {
            color: #80ccff
        }

        .log-enemy {
            color: #ff80aa
        }

        .log-system {
            color: #c0a0ff
        }

        .log-damage {
            color: #ff6060
        }

        .log-heal {
            color: #60ff90
        }

        .log-ougi {
            color: #ffcc40;
            font-weight: 700
        }

        /* é¸æŠãƒ‘ãƒãƒ« */
        .select-area {
            margin-bottom: 14px
        }

        .select-area h3 {
            font-size: 0.8rem;
            color: #9070c0;
            margin-bottom: 8px;
            letter-spacing: 0.1em;
            font-weight: 700
        }

        .normal-moves {
            display: flex;
            gap: 10px;
            margin-bottom: 14px
        }

        .move-btn {
            flex: 1;
            padding: 12px 8px;
            border: 1px solid rgba(150, 100, 255, 0.3);
            background: rgba(80, 40, 150, 0.2);
            border-radius: 12px;
            color: #d0b0ff;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px
        }

        .move-btn span.icon {
            font-size: 1.8rem
        }

        .move-btn:hover:not(:disabled) {
            background: rgba(120, 60, 220, 0.35);
            border-color: #a060ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(150, 60, 255, 0.3)
        }

        .move-btn:active:not(:disabled) {
            transform: translateY(0)
        }

        .move-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
            transform: none
        }

        .move-btn.sealed {
            opacity: 0.3;
            cursor: not-allowed;
            position: relative
        }

        .move-btn.sealed::after {
            content: 'å°å°';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff5050;
            font-size: 0.75rem;
            font-weight: 900;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 8px;
            border-radius: 6px;
        }

        /* å¥¥ç¾©ã‚°ãƒªãƒƒãƒ‰ */
        .ougi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px
        }

        .ougi-btn {
            padding: 10px 8px;
            border-radius: 10px;
            border: 1px solid rgba(150, 80, 255, 0.25);
            background: rgba(60, 20, 120, 0.2);
            color: #c0a0e0;
            font-family: inherit;
            font-size: 0.72rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 3px
        }

        .ougi-btn:hover:not(:disabled):not(.sealed) {
            background: rgba(100, 40, 200, 0.3);
            border-color: #9050ee;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(120, 50, 200, 0.25)
        }

        .ougi-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed
        }

        .ougi-btn.sealed {
            opacity: 0.3;
            cursor: not-allowed
        }

        .ougi-btn.active-toggle {
            border-color: #8080ff;
            background: rgba(60, 60, 200, 0.25);
            box-shadow: 0 0 10px rgba(100, 100, 255, 0.3)
        }

        .ougi-btn .o-name {
            font-weight: 700;
            font-size: 0.78rem;
            color: #e0c0ff
        }

        .ougi-btn .o-cost {
            font-size: 0.68rem;
            color: #9080b0
        }

        .ougi-btn .o-ct {
            font-size: 0.65rem;
            color: #706080
        }

        .ougi-btn .o-attr {
            font-size: 0.65rem;
            padding: 1px 5px;
            border-radius: 4px;
            width: fit-content
        }

        .attr-goo {
            background: rgba(255, 100, 100, 0.15);
            color: #ff9090;
            border: 1px solid rgba(255, 100, 100, 0.3)
        }

        .attr-choki {
            background: rgba(100, 100, 255, 0.15);
            color: #9090ff;
            border: 1px solid rgba(100, 100, 255, 0.3)
        }

        .attr-pa {
            background: rgba(100, 200, 100, 0.15);
            color: #90dd90;
            border: 1px solid rgba(100, 200, 100, 0.3)
        }

        .attr-special {
            background: rgba(200, 150, 255, 0.15);
            color: #d0a0ff;
            border: 1px solid rgba(200, 150, 255, 0.3)
        }

        .ougi-btn .ct-remaining {
            position: absolute;
            top: 6px;
            right: 8px;
            font-size: 0.7rem;
            color: #ff7050;
            font-weight: 700
        }

        /* ãƒãƒƒã‚­ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px)
        }

        .modal-box {
            background: linear-gradient(135deg, #1a0535, #0d0025);
            border: 1px solid rgba(180, 100, 255, 0.4);
            border-radius: 20px;
            padding: 28px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 60px rgba(150, 50, 255, 0.3)
        }

        .modal-box h3 {
            font-size: 1.1rem;
            font-weight: 900;
            color: #c0a0ff;
            margin-bottom: 6px
        }

        .modal-box p {
            font-size: 0.8rem;
            color: #907090;
            margin-bottom: 18px
        }

        .modal-moves {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px
        }

        .modal-ougi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 300px;
            overflow-y: auto
        }

        /* ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ */
        .gameover-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px)
        }

        .gameover-box {
            text-align: center;
            animation: fadeInUp 0.6s ease
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .gameover-title {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 10px
        }

        .gameover-title.win {
            background: linear-gradient(90deg, #80ffaa, #40ff80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none
        }

        .gameover-title.lose {
            background: linear-gradient(90deg, #ff6080, #ff3050);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none
        }

        .gameover-title.draw {
            background: linear-gradient(90deg, #d0c0ff, #a080ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none
        }

        .gameover-sub {
            font-size: 1rem;
            color: #a080c0;
            margin-bottom: 28px
        }

        .restart-btn {
            padding: 14px 40px;
            background: linear-gradient(135deg, #7030c0, #4020a0);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(100, 40, 200, 0.4)
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(100, 40, 200, 0.6)
        }

        /* CPUæ€è€ƒè¡¨ç¤º */
        #cpu-thinking {
            text-align: center;
            font-size: 0.78rem;
            color: #806090;
            height: 20px;
            margin-bottom: 8px
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        #ougi-tooltip {
            display: none;
            position: fixed;
            z-index: 9999;
            max-width: 260px;
            background: rgba(20, 5, 40, 0.97);
            border: 1px solid rgba(180, 100, 255, 0.4);
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 0.76rem;
            color: #d0b0ff;
            line-height: 1.5;
            pointer-events: none;
            box-shadow: 0 4px 24px rgba(120, 40, 200, 0.5);
            backdrop-filter: blur(6px)
        }

        .hidden {
            display: none !important
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>âš”ï¸ ã‚¸ãƒ£ãƒ³ã‚±ãƒ³åä¸‰å¥¥ç¾©</h1>
            <p>å¥¥ç¾©ã‚’é§†ä½¿ã—ã¦ç›¸æ‰‹ã®HPã‚’0ã«ã›ã‚ˆ</p>
        </header>

        <!-- ãƒãƒˆãƒ«ãƒ­ã‚° -->
        <div class="log-container" id="log-container"></div>

        <!-- CPUæ€è€ƒ -->
        <div id="cpu-thinking"></div>

        <!-- ãƒãƒˆãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
        <div class="battlefield">
            <div class="player-panel player" id="player-panel">
                <div class="panel-name">â–¶ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
                <div class="panel-hp">
                    <div class="bar-label"><span>HP</span><span id="p-hp-val">70/100</span></div>
                    <div class="bar-track">
                        <div class="bar-fill hp-fill" id="p-hp-bar" style="width:70%"></div>
                    </div>
                </div>
                <div class="panel-op">
                    <div class="bar-label"><span>OP</span><span id="p-op-val">0/30</span></div>
                    <div class="bar-track">
                        <div class="bar-fill op-fill" id="p-op-bar" style="width:0%"></div>
                    </div>
                </div>
                <div class="status-tags" id="p-tags"></div>
            </div>

            <div class="vs-block">
                <div class="vs-text">VS</div>
                <div class="turn-num" id="turn-display">ã‚¿ãƒ¼ãƒ³ 1</div>
            </div>

            <div class="player-panel enemy" id="enemy-panel">
                <div class="panel-name">â—€ CPU</div>
                <div class="panel-hp">
                    <div class="bar-label"><span>HP</span><span id="e-hp-val">70/100</span></div>
                    <div class="bar-track">
                        <div class="bar-fill hp-fill" id="e-hp-bar" style="width:70%"></div>
                    </div>
                </div>
                <div class="panel-op">
                    <div class="bar-label"><span>OP</span><span id="e-op-val">0/30</span></div>
                    <div class="bar-track">
                        <div class="bar-fill op-fill" id="e-op-bar" style="width:0%"></div>
                    </div>
                </div>
                <div class="status-tags" id="e-tags"></div>
            </div>
        </div>

        <!-- æ‰‹è¡¨ç¤º -->
        <div class="hands-display">
            <div class="hand-shown" id="p-hand-shown">
                <span class="hand-icon">â“</span>
                <div class="hand-name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
            </div>
            <div class="result-banner" id="result-banner" style="opacity:0">-</div>
            <div class="hand-shown" id="e-hand-shown">
                <span class="hand-icon">â“</span>
                <div class="hand-name">CPU</div>
            </div>
        </div>

        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠ -->
        <div class="select-area" id="select-area">
            <h3>â—† é€šå¸¸æ‰‹</h3>
            <div class="normal-moves">
                <button class="move-btn" id="btn-goo" onclick="playerSelect('goo')">
                    <span class="icon">âœŠ</span>ã‚°ãƒ¼
                </button>
                <button class="move-btn" id="btn-choki" onclick="playerSelect('choki')">
                    <span class="icon">âœŒï¸</span>ãƒãƒ§ã‚­
                </button>
                <button class="move-btn" id="btn-pa" onclick="playerSelect('pa')">
                    <span class="icon">ğŸ–ï¸</span>ãƒ‘ãƒ¼
                </button>
            </div>
            <h3>â—† å¥¥ç¾©</h3>
            <div class="ougi-grid" id="ougi-grid"></div>
        </div>
    </div>

    <!-- ãƒãƒƒã‚­ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay hidden" id="hacking-modal">
        <div class="modal-box">
            <h3>ğŸ”“ ãƒãƒƒã‚­ãƒ³ã‚°ç™ºå‹•</h3>
            <p>ç›¸æ‰‹ã®æ‰‹ã‚’ç¢ºèªã—ãŸã€‚ã©ã®æ‰‹ã‚’å‡ºã™ï¼Ÿ</p>
            <div id="hacking-enemy-info"
                style="margin-bottom:12px;padding:10px;background:rgba(255,100,150,0.1);border-radius:8px;font-size:0.82rem;color:#ffaacc">
            </div>
            <div id="hacking-choices"
                style="display:flex;flex-direction:column;gap:6px;max-height:60vh;overflow-y:auto"></div>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ -->
    <div class="gameover-overlay hidden" id="gameover-overlay">
        <div class="gameover-box">
            <div class="gameover-title" id="gameover-title">WINNER!</div>
            <div class="gameover-sub" id="gameover-sub"></div>
            <button class="restart-btn" onclick="restartGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        </div>
    </div>

    <div id="ougi-tooltip"></div>
    <script src="game.js"></script>
</body>

</html>
